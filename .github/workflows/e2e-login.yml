name: Login Tests CI (E2E & Unit)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-login:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      # 1. CÃ€I Äáº¶T BACKEND (JAVA) VÃ€ KHá»I Äá»˜NG SERVER 
      # Cáº§n thiáº¿t cho E2E Tests (Backend cháº¡y trÃªn cá»•ng 8080)
      - name: âš™ï¸ Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: ğŸƒ Run Backend Server (Port 8080)
        # Build vÃ  cháº¡y server Spring Boot á»Ÿ cháº¿ Ä‘á»™ ná»n (&)
        run: |
          cd backend
          mvn clean install -DskipTests 
          mvn spring-boot:run & 
          # Äá»£i Ä‘á»ƒ server Backend khá»Ÿi Ä‘á»™ng hoÃ n toÃ n
          echo "Waiting 15 seconds for Backend (8080) to start..."
          sleep 15
        shell: bash
        
      # 2. CÃ€I Äáº¶T FRONTEND (NODE.JS)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install frontend dependencies
        run: |
          cd frontend
          npm install

      # 3. CHáº Y LOGIN UNIT TESTS (Chá»‰ cáº§n code, khÃ´ng cáº§n server)
      - name: ğŸ§ª Run Login Unit Tests
        run: |
          cd frontend
          npm test -- --testPathPattern=Login --watchAll=false

      # 4. CHáº Y LOGIN E2E TESTS (Cáº¦N Cáº¢ 2 SERVER CHáº Y)
      - name: ğŸŒ Run Cypress E2E Login Tests (Requirement 6.1.3)
        # Sá»­ dá»¥ng cypress-io/github-action Ä‘á»ƒ quáº£n lÃ½ viá»‡c khá»Ÿi Ä‘á»™ng Frontend vÃ  cháº¡y test tá»‘t hÆ¡n
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          # Khá»Ÿi Ä‘á»™ng Frontend server (thÆ°á»ng lÃ  npm run dev)
          start: npm run dev 
          # Chá» cho Frontend server sáºµn sÃ ng
          wait-on: 'http://localhost:5173' # Giáº£ Ä‘á»‹nh Frontend cháº¡y cá»•ng 5173
          # Chá»‰ Ä‘á»‹nh lá»‡nh cháº¡y test vÃ  file spec
          spec: cypress/e2e/login.spec.js 
          browser: chrome
        env:
          # Truyá»n Ä‘á»‹a chá»‰ API Backend (Spring Boot 8080) cho code Frontend/Cypress
          REACT_APP_API_BASE_URL: http://localhost:8080