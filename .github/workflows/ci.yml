
name: 6.2.3 Complete CI/CD Pipeline

# Kích hoạt khi Push (cho CD) và Pull Request (cho CI)
on: 
  push:
    branches: [ main]
  pull_request:
    branches: [ main]

jobs:
  # Job 1: BUILD & TEST (CI)
  build-test:
    name: Build & Run All Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        uses: cypress-io/github-action/install-dependencies@v3
        with:
          npm-install-command: 'npm install'

      # BƯỚC 1: BUILD Ứng dụng (npm run build)
      - name: Build Application for Production (Vite)
        run: npm run build 
        
      # BƯỚC 2: CHẠY KIỂM THỬ (Chạy TẤT CẢ Tests)
      - name: Start App and Run Cypress All Tests
        uses: cypress-io/github-action@v6
        with:
          spec: cypress/e2e/**/*.cy.js 
          start: npm run dev & 
          wait-on: 'http://localhost:5173'
          install: false
          
      # BƯỚC 3: UPLOAD ARTIFACT (Lưu trữ file Build cho Deploy)
      - name: Upload Build Artifact for Deployment
        uses: actions/upload-artifact@v4
        # Chỉ upload khi không phải PR
        if: success() && github.event_name != 'pull_request' 
        with:
          name: production-build
          path: dist # <-- Xác nhận output build của Vite là 'dist'

  # 
  # Job 2: TRIỂN KHAI (CD)
  #
  deploy:
    name: Deploy to Hosting Service (CD)
    runs-on: ubuntu-latest
    needs: build-test 
    # CHỈ CHẠY khi push lên nhánh chính VÀ build-test thành công
    if: success() && github.ref == 'refs/heads/main' 
    
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: . 

      - name: Deploy to Netlify (Example)
        uses: netlify/actions/cli@v3
        with:
          args: deploy --dir=./dist --prod
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}